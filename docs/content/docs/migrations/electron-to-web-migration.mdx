---
title: Electron 迁移至 Web 平台
description: 记录从 Electron 迁移到 Web 的文档
---

# Electron 迁移至 Web 平台

## 转向 Web 的原因

使用 Electron 时，入门存在很多障碍

- 需要下载数百 MB 的应用程序（尽管可以更小）
- 设置/管理本地开发环境。我们的用户技术背景较弱，这是不必要的障碍。
- 我们花费了大量支持时间帮助用户调试本地机器

而使用 Web，我们可以获得以下好处

- 在任何机器的任何地方开始编辑
- 跨桌面恢复编辑并在团队间共享
- 实时协作
- 无需本地机器设置/维护

## 映射到 Web 等效方案

### “前端”部分

```
BrowserView 		-> 	Next.js app
```

幸运的是，Electron 提供了 Web UI，因此我们的大部分 React/TailwindCSS 样式得以保留。不过许多服务器通信需要从 Electron IPC 映射到客户端-服务器模式。我们使用 tRPC 替换了这些通信以保持类型安全。

### 画布/框架部分：

```
WebView 		-> 	iFrame
```

我们之前使用的是 Electron webview，它的行为类似于 iframe，但具有更好的跨域支持。webview 允许我们在 BrowserView 和 Webview 之间进行通信，直接修改应用的 DOM 树。现在我们将其替换为 iframe，但 iframe 在进程间通信方面限制更多。例如，浏览器禁止网站直接与不同源的 iframe 元素交互。我们的 Web 应用与所服务的应用不在同一源，因此必须设法绕过这一限制。

我们决定在用户应用端注入一个脚本，通过 postMessage 实现进程间通信。
https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage

该脚本内部称为预加载脚本，通过 CDN 注入到应用的布局中。

### “后端”

```
Node Server		-> 	Remote container
```

由于 Electron 是一个具有文件系统访问权限的 Node 服务器，我们之前使用该 Node 服务器直接编辑用户应用的代码。由于现在我们不再拥有“用户机器”，我们将其替换为一个抽象的云容器。这可以是任何具有文件系统 API 的系统，我们可以对其进行读/写/监听。目前使用的是 CodeSandbox，但也可以是任何提供商，甚至是本地运行的容器。

### 额外内容

```
Local memory 	->	Supabase + Caching
```

此前，我们将大部分用户/项目信息以序列化 JSON 格式存储在用户机器上。现在，我们将它们存储在 Supabase 的 Postgres 表中。我们在浏览器中的 Postgres 之上维护了一个缓存层，以便于访问和改善加载性能。

## 先前架构

![先前架构](/images/electron-to-web-before.png)

## 更新后架构

![更新后架构](/images/electron-to-web-after.png)

## 完整更新后架构（包含所有组件）

![完整更新后架构](/images/full-architecture.png)

## 参考文献

- [Electron 代码库](https://github.com/onlook-dev/desktop)
- [Web 代码库](https://github.com/onlook-dev/onlook)